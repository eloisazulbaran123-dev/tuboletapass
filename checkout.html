<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - TuBoleta</title>
  <link rel="stylesheet" href="/src/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    .checkout-header { background: var(--blue); padding: 1rem 0; }
    .checkout-header .container { display: flex; align-items: center; justify-content: space-between; }
    .back-btn { display: flex; align-items: center; gap: 0.5rem; color: var(--white); text-decoration: none; }
    .secure-badge { display: flex; align-items: center; gap: 0.5rem; color: var(--white); font-size: 0.85rem; }
    .checkout-page { padding: 2rem 0; background: var(--gray); min-height: 80vh; }
    .checkout-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    .checkout-card { background: var(--white); border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 1.5rem; margin-bottom: 1.5rem; }
    .checkout-card h2 { font-size: 1.1rem; font-weight: 700; color: var(--blue); margin-bottom: 1rem; }
    .order-item { display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--border); }
    .order-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .order-item-info h4 { font-size: 0.9rem; font-weight: 600; color: var(--blue); }
    .order-item-info p { font-size: 0.8rem; color: var(--text-light); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text); font-size: 0.9rem; }
    .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; font-family: inherit; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--cyan); }
    .form-group input:disabled { background: #f5f5f5; cursor: not-allowed; }
    .form-row { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; }
    .payment-methods { display: grid; gap: 1rem; margin-bottom: 1.5rem; }
    .payment-method { display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .payment-method:hover, .payment-method.selected { border-color: var(--cyan); background: rgba(0,180,216,0.05); }
    .payment-method-icon { width: 44px; height: 44px; border-radius: 8px; background: var(--gray); display: flex; align-items: center; justify-content: center; }
    .payment-method.selected .payment-method-icon { background: var(--cyan); color: white; }
    .payment-method h4 { font-weight: 600; color: var(--blue); font-size: 0.95rem; margin: 0; }
    .payment-method p { font-size: 0.8rem; color: var(--text-light); margin: 0.25rem 0 0 0; }
    .provider-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin: 1rem 0; }
    .provider-option { padding: 1rem; border: 2px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; background: white; }
    .provider-option:hover, .provider-option.selected { border-color: var(--cyan); background: rgba(0,180,216,0.05); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,180,216,0.2); }
    .provider-logo { width: 60px; height: 60px; object-fit: contain; display: block; }
    .provider-option span { display: block; font-size: 0.85rem; font-weight: 600; color: var(--blue); }
    .summary-card { background: var(--white); border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .summary-header { padding: 1rem; border-bottom: 1px solid var(--border); }
    .summary-body { padding: 1rem; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light); }
    .summary-row.total { font-weight: 700; color: var(--blue); border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem; }
    .summary-row.total span:last-child { color: var(--cyan); }
    .hidden { display: none !important; }
    .btn-primary { width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--yellow) 0%, #e6a800 100%); color: white; font-size: 1rem; font-weight: 700; border-radius: 10px; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230,184,0,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    
    /* Alerta de autenticaci√≥n */
    .auth-alert { 
      background: #fff3cd; 
      border: 1px solid #ffc107; 
      color: #856404; 
      padding: 1rem; 
      border-radius: 8px; 
      margin-bottom: 1rem; 
      display: flex; 
      align-items: center; 
      gap: 0.75rem;
    }
    .auth-alert svg { min-width: 20px; }
    
    @media (min-width: 768px) { 
      .checkout-grid { grid-template-columns: 1fr 320px; } 
      .provider-grid { grid-template-columns: repeat(3, 1fr); } 
    }
  </style>
</head>
<body>
  <header class="checkout-header">
    <div class="container">
      <a href="/" class="back-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <span class="logo">Tub<span style="color: var(--yellow);">o</span>leta</span>
      </a>
      <div class="secure-badge">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        Compra segura
      </div>
    </div>
  </header>

  <main class="checkout-page">
    <div class="container">
      <div id="mainStep">
        <div class="checkout-grid">
          <div>
            <div class="checkout-card">
              <h2>Tu orden</h2>
              <div id="orderItems"></div>
            </div>

            <div class="checkout-card">
              <h2>Informaci√≥n de contacto</h2>
              
              <!-- ALERTA SI NO EST√Å AUTENTICADO -->
              <div id="authAlert" class="auth-alert hidden">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <div>
                  <strong>Debes iniciar sesi√≥n para completar tu compra.</strong>
                  <a href="/login.html" style="color: var(--cyan); text-decoration: underline; display: block; margin-top: 0.25rem;">Iniciar sesi√≥n aqu√≠</a>
                </div>
              </div>
              
              <div class="form-group">
                <label>Correo electr√≥nico *</label>
                <input type="email" id="email" placeholder="tu@email.com" required disabled />
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label>Nombre *</label>
                  <input type="text" id="name" placeholder="Tu nombre" required disabled />
                </div>
                <div class="form-group">
                  <label>Tel√©fono *</label>
                  <input type="tel" id="phone" placeholder="+57 300 123 4567" required disabled />
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label>Tipo de documento *</label>
                  <select id="docType" required>
                    <option value="">Seleccionar</option>
                    <option value="CC">C√©dula de Ciudadan√≠a</option>
                    <option value="CE">C√©dula de Extranjer√≠a</option>
                    <option value="TI">Tarjeta de Identidad</option>
                    <option value="PAS">Pasaporte</option>
                    <option value="NIT">NIT</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>N√∫mero de documento *</label>
                  <input type="text" id="docNumber" placeholder="1234567890" required />
                </div>
              </div>
            </div>

            <div class="checkout-card">
              <h2>M√©todo de pago</h2>
              <div class="payment-methods">
                <div class="payment-method selected" data-method="card">
                  <div class="payment-method-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  </div>
                  <div>
                    <h4>Tarjeta cr√©dito/d√©bito</h4>
                    <p>Visa, Mastercard, Amex</p>
                  </div>
                </div>
                <div class="payment-method" data-method="transfer">
                  <div class="payment-method-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                  </div>
                  <div>
                    <h4>Transferencia / Billetera</h4>
                    <p>Nequi, Daviplata, Bancolombia</p>
                  </div>
                </div>
              </div>

              <div id="cardForm">
                <div class="form-group">
                  <label>N√∫mero de tarjeta</label>
                  <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" />
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div class="form-group">
                    <label>Vencimiento</label>
                    <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" />
                  </div>
                  <div class="form-group">
                    <label>CVC</label>
                    <input type="text" id="cardCvc" placeholder="123" maxlength="4" />
                  </div>
                </div>
                <div class="form-group">
                  <label>Nombre en tarjeta</label>
                  <input type="text" id="cardName" placeholder="NOMBRE APELLIDO" />
                </div>
              </div>

              <div id="transferForm" class="hidden">
                <h4 style="font-size: 0.9rem; color: var(--blue); margin-bottom: 0.75rem;">Selecciona tu proveedor:</h4>
                <div class="provider-grid">
                  <div class="provider-option" data-provider="Nequi">
                    <img src="logos/nequi.png" alt="Nequi" class="provider-logo" onerror="this.style.display='none';this.nextElementSibling.style.fontSize='2rem';">
                    <span>Nequi</span>
                  </div>
                  <div class="provider-option" data-provider="Daviplata">
                    <img src="logos/daviplata.png" alt="Daviplata" class="provider-logo" onerror="this.style.display='none'">
                    <span>Daviplata</span>
                  </div>
                  <div class="provider-option" data-provider="Bancolombia">
                    <img src="logos/bancolombia.png" alt="Bancolombia" class="provider-logo" onerror="this.style.display='none'">
                    <span>Bancolombia</span>
                  </div>
                  <div class="provider-option" data-provider="Davivienda">
                    <img src="logos/Davivienda.png" alt="Davivienda" class="provider-logo" onerror="this.style.display='none'">
                    <span>Davivienda</span>
                  </div>
                  <div class="provider-option" data-provider="BBVA">
                    <img src="logos/bbva.png" alt="BBVA" class="provider-logo" onerror="this.style.display='none'">
                    <span>BBVA</span>
                  </div>
                  <div class="provider-option" data-provider="Otros">
                    <span style="font-size:2rem;">üè¶</span>
                    <span>Otros</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div>
            <div class="summary-card">
              <div class="summary-header">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--blue);">Resumen de compra</h3>
              </div>
              <div class="summary-body">
                <div id="summaryItems"></div>
                <button id="checkoutBtn" class="btn-primary" disabled>
                  <span id="btnText">Completar compra</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, ordersApi } from '/src/supabase.ts';

    let cartItem = null;
    let selectedPaymentMethod = 'card';
    let selectedProvider = null;
    let currentUser = null; // ‚úÖ NUEVA VARIABLE PARA USUARIO AUTENTICADO

    async function init() {
      // ‚úÖ PASO 1: VERIFICAR AUTENTICACI√ìN
      await checkAuthentication();
      
      cartItem = JSON.parse(localStorage.getItem('tuboleta-cart') || 'null');

      if (!cartItem) {
        alert('No hay art√≠culos en el carrito');
        window.location.href = '/';
        return;
      }

      renderOrderItems();
      renderSummary();
      setupPaymentMethods();
      setupProviderSelection();
      
      // ‚úÖ SOLO HABILITAR BOT√ìN SI EST√Å AUTENTICADO
      if (currentUser) {
        document.getElementById('checkoutBtn').disabled = false;
      }

      document.getElementById('checkoutBtn').addEventListener('click', handleCheckout);
    }

    // ‚úÖ NUEVA FUNCI√ìN: VERIFICAR AUTENTICACI√ìN
    async function checkAuthentication() {
      try {
        currentUser = await auth.getUser();
        
        if (!currentUser) {
          // Usuario NO autenticado - mostrar alerta
          document.getElementById('authAlert').classList.remove('hidden');
          document.getElementById('checkoutBtn').disabled = true;
          document.getElementById('checkoutBtn').innerHTML = 'üîí Debes iniciar sesi√≥n';
          return;
        }

        // Usuario autenticado - cargar datos
        console.log('‚úÖ Usuario autenticado:', currentUser.email);
        document.getElementById('email').value = currentUser.email;
        document.getElementById('email').disabled = true;
        document.getElementById('name').value = currentUser.name || '';
        document.getElementById('name').disabled = false;
        document.getElementById('phone').value = currentUser.phone || '';
        document.getElementById('phone').disabled = false;
        
      } catch (error) {
        console.error('Error verificando autenticaci√≥n:', error);
        document.getElementById('authAlert').classList.remove('hidden');
        document.getElementById('checkoutBtn').disabled = true;
      }
    }

    function renderOrderItems() {
      const container = document.getElementById('orderItems');
      if (!container || !cartItem) return;
      
      container.innerHTML = `
        <div class="order-item">
          <img src="${cartItem.eventImage || cartItem.image}" alt="${cartItem.eventName || cartItem.title}" />
          <div class="order-item-info" style="flex: 1;">
            <h4>${cartItem.eventName || cartItem.title}</h4>
            <p>${cartItem.eventVenue || ''}</p>
            <p>${cartItem.eventDate || ''}</p>
            <p style="color:var(--cyan);font-weight:600;">${cartItem.ticketType}</p>
            <p style="margin-top: 0.5rem;">Cantidad: ${cartItem.quantity}</p>
          </div>
        </div>
      `;
    }

    function renderSummary() {
      const container = document.getElementById('summaryItems');
      if (!container || !cartItem) return;
      
      // ‚úÖ Calcular totales de forma m√°s robusta (igual que en las funciones de pago)
      let subtotal = 0;
      let fee = 0;
      let total = 0;

      if (cartItem.subtotal && cartItem.serviceFee && cartItem.total) {
        subtotal = cartItem.subtotal;
        fee = cartItem.serviceFee;
        total = cartItem.total;
      } else if (cartItem.total) {
        subtotal = Math.round(cartItem.total / 1.1);
        fee = cartItem.total - subtotal;
        total = cartItem.total;
      } else if (cartItem.price && cartItem.quantity) {
        subtotal = cartItem.price * cartItem.quantity;
        fee = Math.round(subtotal * 0.1);
        total = subtotal + fee;
      }

      container.innerHTML = `
        <div style="margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border);">
          <div style="display:flex;justify-content:space-between;">
            <span style="font-weight:500;">${cartItem.ticketType || 'Entrada'}</span>
            <span>x${cartItem.quantity || 1}</span>
          </div>
        </div>
        <div class="summary-row">
          <span>Subtotal</span>
          <span>${formatPrice(subtotal)}</span>
        </div>
        <div class="summary-row">
          <span>Cargo por servicio (10%)</span>
          <span>${formatPrice(fee)}</span>
        </div>
        <div class="summary-row total">
          <span>Total a pagar</span>
          <span>${formatPrice(total)}</span>
        </div>
      `;
    }

    function setupPaymentMethods() {
      const methods = document.querySelectorAll('.payment-method');
      const cardForm = document.getElementById('cardForm');
      const transferForm = document.getElementById('transferForm');

      methods.forEach(method => {
        method.addEventListener('click', () => {
          methods.forEach(m => m.classList.remove('selected'));
          method.classList.add('selected');
          selectedPaymentMethod = method.dataset.method;

          if (selectedPaymentMethod === 'card') {
            cardForm.classList.remove('hidden');
            transferForm.classList.add('hidden');
          } else {
            cardForm.classList.add('hidden');
            transferForm.classList.remove('hidden');
          }
        });
      });
    }

    function setupProviderSelection() {
      const providers = document.querySelectorAll('.provider-option');
      providers.forEach(provider => {
        provider.addEventListener('click', () => {
          providers.forEach(p => p.classList.remove('selected'));
          provider.classList.add('selected');
          selectedProvider = provider.dataset.provider;
        });
      });
    }

    async function handleCheckout() {
      // ‚úÖ VALIDACI√ìN ADICIONAL DE AUTENTICACI√ìN
      if (!currentUser) {
        alert('‚ùå Debes iniciar sesi√≥n para completar tu compra');
        window.location.href = '/login.html';
        return;
      }

      if (!validateForm()) return;

      const btn = document.getElementById('checkoutBtn');
      const btnText = document.getElementById('btnText');
      
      btn.disabled = true;
      btnText.textContent = 'Procesando...';

      try {
        if (selectedPaymentMethod === 'card') {
          await processCardPayment();
        } else {
          await processTransferPayment();
        }
      } catch (error) {
        console.error('Error procesando pago:', error);
        alert('Hubo un error procesando tu pago. Por favor intenta nuevamente.');
        btn.disabled = false;
        btnText.textContent = 'Completar compra';
      }
    }

    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const docType = document.getElementById('docType').value;
      const docNumber = document.getElementById('docNumber').value.trim();

      if (!name || !email || !phone || !docType || !docNumber) {
        alert('Por favor completa todos los campos obligatorios');
        return false;
      }

      if (docNumber.length < 6) {
        alert('El n√∫mero de documento debe tener al menos 6 caracteres');
        return false;
      }

      if (!selectedPaymentMethod) {
        alert('Selecciona un m√©todo de pago');
        return false;
      }

      if (selectedPaymentMethod === 'card') {
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const cardExpiry = document.getElementById('cardExpiry').value.trim();
        const cardCvc = document.getElementById('cardCvc').value.trim();
        const cardName = document.getElementById('cardName').value.trim();

        if (!cardNumber || !cardExpiry || !cardCvc || !cardName) {
          alert('Completa los datos de la tarjeta');
          return false;
        }
      } else {
        if (!selectedProvider) {
          alert('Selecciona un proveedor');
          return false;
        }
      }

      return true;
    }

    async function processCardPayment() {
      const orderNumber = 'TB-' + Date.now() + Math.floor(Math.random() * 1000);

      // ‚úÖ Calcular totales de forma m√°s robusta
      let subtotal = 0;
      let serviceFee = 0;
      let total = 0;

      if (cartItem.subtotal && cartItem.serviceFee && cartItem.total) {
        // Ya tiene todo calculado
        subtotal = cartItem.subtotal;
        serviceFee = cartItem.serviceFee;
        total = cartItem.total;
      } else if (cartItem.total) {
        // Solo tiene total, calcular fee del 10%
        subtotal = Math.round(cartItem.total / 1.1); // Descontar el 10%
        serviceFee = cartItem.total - subtotal;
        total = cartItem.total;
      } else if (cartItem.price && cartItem.quantity) {
        // Calcular desde precio unitario
        subtotal = cartItem.price * cartItem.quantity;
        serviceFee = Math.round(subtotal * 0.1);
        total = subtotal + serviceFee;
      } else {
        console.error('‚ùå No se pudo calcular el total del carrito:', cartItem);
        alert('Error: No se pudo calcular el total de la orden');
        return;
      }

      console.log('üí∞ Totales calculados:', { subtotal, serviceFee, total });

      const orderData = {
        order: orderNumber,
        email: currentUser.email,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        docType: document.getElementById('docType').value,
        docNumber: document.getElementById('docNumber').value,
        amount: total,
        items: [cartItem],
        status: 'completed',
        date: new Date().toISOString(),
        paymentMethod: 'card',
        cardLastFour: document.getElementById('cardNumber').value.slice(-4)
      };

      // Guardar en localStorage (para compatibilidad)
      const payments = JSON.parse(localStorage.getItem('tuboleta-card-payments') || '[]');
      payments.push(orderData);
      localStorage.setItem('tuboleta-card-payments', JSON.stringify(payments));

      // ‚úÖ GUARDAR EN SUPABASE con total_amount num√©rico y payment_details
      try {
        console.log('üì§ Enviando a Supabase:', {
          user_id: currentUser.id,
          user_email: currentUser.email,
          event_id: cartItem.eventId,
          amount: total,
          total_amount: total
        });

        const supabaseOrder = await ordersApi.create({
          user_id: currentUser.id,
          user_email: currentUser.email, // ‚úÖ Agregar user_email
          event_id: cartItem.eventId,
          tickets: { items: [cartItem] },
          amount: total, // ‚úÖ Para compatibilidad con columna 'amount'
          total_amount: total, // ‚úÖ N√öMERO FINAL
          payment_details: { // ‚úÖ DETALLES COMPLETOS EN JSON
            subtotal: subtotal,
            serviceFee: serviceFee,
            total: total,
            items: [cartItem]
          },
          status: 'completed',
          payment_method: 'card',
          payment_reference: orderNumber
        });
        
        console.log('‚úÖ Orden guardada en Supabase:', supabaseOrder);
      } catch (error) {
        console.error('‚ùå Error guardando en Supabase:', error);
        throw error;
      }

      localStorage.removeItem('tuboleta-cart');
      localStorage.setItem('tuboleta-last-order', JSON.stringify(orderData));
      window.location.href = '/confirmacion.html';
    }

    async function processTransferPayment() {
      const orderNumber = 'TB-' + Date.now() + Math.floor(Math.random() * 1000);
      const referenceNumber = Math.floor(100000000 + Math.random() * 900000000).toString();

      // ‚úÖ Calcular totales de forma m√°s robusta
      let subtotal = 0;
      let serviceFee = 0;
      let total = 0;

      if (cartItem.subtotal && cartItem.serviceFee && cartItem.total) {
        // Ya tiene todo calculado
        subtotal = cartItem.subtotal;
        serviceFee = cartItem.serviceFee;
        total = cartItem.total;
      } else if (cartItem.total) {
        // Solo tiene total, calcular fee del 10%
        subtotal = Math.round(cartItem.total / 1.1);
        serviceFee = cartItem.total - subtotal;
        total = cartItem.total;
      } else if (cartItem.price && cartItem.quantity) {
        // Calcular desde precio unitario
        subtotal = cartItem.price * cartItem.quantity;
        serviceFee = Math.round(subtotal * 0.1);
        total = subtotal + serviceFee;
      } else {
        console.error('‚ùå No se pudo calcular el total del carrito:', cartItem);
        alert('Error: No se pudo calcular el total de la orden');
        return;
      }

      console.log('üí∞ Totales calculados:', { subtotal, serviceFee, total });

      const orderData = {
        order: orderNumber,
        email: currentUser.email,
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        docType: document.getElementById('docType').value,
        docNumber: document.getElementById('docNumber').value,
        amount: total,
        items: [cartItem],
        status: 'pending',
        date: new Date().toISOString(),
        paymentMethod: 'transfer',
        provider: selectedProvider,
        ref: referenceNumber
      };

      const payments = JSON.parse(localStorage.getItem('tuboleta-pending') || '[]');
      payments.push(orderData);
      localStorage.setItem('tuboleta-pending', JSON.stringify(payments));

      // ‚úÖ GUARDAR EN SUPABASE con total_amount num√©rico y payment_details
      try {
        console.log('üì§ Enviando a Supabase:', {
          user_id: currentUser.id,
          user_email: currentUser.email,
          event_id: cartItem.eventId,
          amount: total,
          total_amount: total
        });

        const supabaseOrder = await ordersApi.create({
          user_id: currentUser.id,
          user_email: currentUser.email, // ‚úÖ Agregar user_email
          event_id: cartItem.eventId,
          tickets: { items: [cartItem] },
          amount: total, // ‚úÖ Para compatibilidad con columna 'amount'
          total_amount: total, // ‚úÖ N√öMERO FINAL
          payment_details: { // ‚úÖ DETALLES COMPLETOS EN JSON
            subtotal: subtotal,
            serviceFee: serviceFee,
            total: total,
            items: [cartItem],
            provider: selectedProvider
          },
          status: 'pending',
          payment_method: 'transfer',
          payment_reference: referenceNumber
        });
        
        console.log('‚úÖ Orden guardada en Supabase:', supabaseOrder);
      } catch (error) {
        console.error('‚ùå Error guardando en Supabase:', error);
        throw error;
      }

      localStorage.removeItem('tuboleta-cart');
      localStorage.setItem('tuboleta-last-order', JSON.stringify(orderData));
      window.location.href = '/confirmacion.html';
    }

    function formatPrice(price) {
      return '$' + Math.round(price).toLocaleString('es-CO');
    }

    // Auto-format
    setTimeout(() => {
      const cardNumber = document.getElementById('cardNumber');
      if (cardNumber) {
        cardNumber.addEventListener('input', (e) => {
          let value = e.target.value.replace(/\s/g, '');
          e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
        });
      }

      const cardExpiry = document.getElementById('cardExpiry');
      if (cardExpiry) {
        cardExpiry.addEventListener('input', (e) => {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 2) {
            value = value.slice(0, 2) + '/' + value.slice(2, 4);
          }
          e.target.value = value;
        });
      }
    }, 200);

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
